---
title: "Flare VM の環境構築"
categories: [security]
tags: ["tag"]
date: 2026-02-18 00:16:42 +0900
toc: true
---

# Flare VM の環境構築

下記のリンクのものをベースとして構築しています。

https://qiita.com/blend-tea/items/b99148e29ca5d7eeeb25

## Flare VM とは

Windows 環境でマルウェア解析を行うための仮想マシン環境です。マルウェア解析やリバースエンジニアリングに必要なツールや環境があらかじめセットアップされています。

実際に入れてみたところ、angr や sage といったツールもあり、CTF で非常に有用だと思います。一般のバイナリは elf だと思うので、あくまで Linux 環境で、という話ですが...

PE Studio や capa といった簡易的な調査を含めて、マルウェア調査を行うことを目的とする、という観点からも非常に有用です。

## 環境構築

私は VMWare WorkStation Pro 25H2 を利用して構築しています。

1. [Windows 11 Pro の iso ファイルを取得](https://www.microsoft.com/en-us/software-download/windows11)し、VMWare WorkStation Pro 25H2 にインストールします。自分はライセンスを取得していません。
2. Flare VM のインストーラーを用意します。
```
(New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1',"$([Environment]::GetFolderPath("Desktop"))\install.ps1")
```
3. 要件として、Windows Defender の諸々や Windows Update をオフにする必要があります。下記を PowerShell で実行します。生成 AI に作らせてみました。
```
# 1. 実行ポリシーを無制限に設定
Set-ExecutionPolicy Unrestricted -Force

# 2. カレントディレクトリ内の ps1 ファイルのブロックをすべて解除
Get-ChildItem -Filter *.ps1 | Unblock-File

# 3. Windows Defender の徹底無効化 (レジストリ経由)
$defenderPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender"
if (!(Test-Path $defenderPath)) { New-Item -Path $defenderPath -Force }
Set-ItemProperty -Path $defenderPath -Name "DisableAntiSpyware" -Value 1

$rtpPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection"
if (!(Test-Path $rtpPath)) { New-Item -Path $rtpPath -Force }
Set-ItemProperty -Path $rtpPath -Name "DisableRealtimeMonitoring" -Value 1
Set-ItemProperty -Path $rtpPath -Name "DisableBehaviorMonitoring" -Value 1
Set-ItemProperty -Path $rtpPath -Name "DisableOnAccessProtection" -Value 1
Set-ItemProperty -Path $rtpPath -Name "DisableScanOnRealtimeEnable" -Value 1

# 4. 長いパス (Long Paths) の有効化 (解析ツールで必須)
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1

# 5. スリープ / ハイバネーションの無効化 (インストール中の停止防止)
powercfg /x -hibernate-timeout-ac 0
powercfg /x -sleep-timeout-ac 0

# 6. Windows Update サービスの停止 (干渉防止)
Stop-Service -Name wuauserv -ErrorAction SilentlyContinue
Set-Service -Name wuauserv -StartupType Disabled

Write-Host "`n[+] Pre-configuration complete! Please restart Windows for best results." -ForegroundColor Green
```
4. 一応、gpedit.msc で参照記事上の設定を無効化します
5. （再起動後）** 必ずスナップショットを取りましょう **
6. 再起動後、デスクトップにある install.ps1 を管理者権限で実行します。
```
Unblock-File .\install.ps1    
Set-ExecutionPolicy Unrestricted -Force
.\install.ps1
```

最初の要件として「Windows Version」と「Windows Defender/Update の無効化」を満たしていないと言われますが、チェックマークを付けると先に進めます。
ツールは入れすぎると時間かかるよなぁ...と思って、やや控えめに。WireShark とかはホストでいいかな？と省いてしまいました。

ただ、これでも途中で再起動が入りつつ、一晩というレベルで時間がかかります。気長に待ちましょう。

## インストール完了後
再度スナップショットを取っておけば、マルウェア実行してしまっても大丈夫です。試しに wannacry でも実行してみるといいと思います。
CTF に対して利用してみているのですが、angr の依存関係でライブラリバージョンを少し弄る必要がありました（何かをダウングレードした気がする）。現状は全部正常に動いていると思います。